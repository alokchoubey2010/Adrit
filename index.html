<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - EDITH</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Poppins Font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Poppins font to the entire body */
        body {
            font-family: 'Poppins', sans-serif;
        }

        /* Custom Scrollbar Styles */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-700 */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-600 */
        }

        /* Keyframe Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .animate-pulse-dot {
            animation: pulse-dot 1.4s infinite ease-in-out both;
        }

        .animation-delay-200 {
            animation-delay: 0.2s;
        }

        .animation-delay-400 {
            animation-delay: 0.4s;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-900 text-gray-100 antialiased">

    <!-- Header -->
    <header class="bg-gray-800 p-4 shadow-md flex items-center justify-center border-b border-gray-700">
        <h1 class="text-2xl font-bold text-blue-400">AI Chatbot <span class="text-sm">(EDITH)</span></h1>
    </header>

    <!-- Chat History -->
    <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
        <div id="initial-message" class="flex justify-center items-center h-full">
            <p class="text-gray-400 text-lg">Start a conversation with EDITH...</p>
        </div>
    </main>

    <!-- Input Area -->
    <form id="chat-form" class="flex items-center p-4 bg-gray-800 border-t border-gray-700 shadow-inner">
        <input
            type="text"
            id="user-input"
            placeholder="Ask EDITH anything..."
            class="flex-1 rounded-full px-5 py-3 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 text-sm md:text-base"
        />
        <button
            type="submit"
            id="send-button"
            class="ml-4 px-5 py-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition-colors duration-200 flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
        >
            <!-- Send Icon SVG -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send">
                <path d="m22 2-7 20-4-9-9-4 20-7Z" />
                <path d="M22 2 11 13" />
            </svg>
            <span class="hidden md:inline ml-2">Send</span>
        </button>
    </form>

    <script>
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const chatForm = document.getElementById('chat-form');
        const sendButton = document.getElementById('send-button');
        // FIX: Changed 'const' to 'let' for initialMessageDiv as its value is reassigned later.
        let initialMessageDiv = document.getElementById('initial-message');

        let messages = []; // Stores the conversation history

        // Function to scroll to the bottom of the chat
        const scrollToBottom = () => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        };

        // Function to create a message element
        const createMessageElement = (text, role, delay = 0) => {
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} opacity-0 animate-fadeIn`;
            messageContainer.style.animationDelay = `${delay}s`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `rounded-xl p-3 max-w-xs md:max-w-md shadow-lg transition-all duration-300 ${
                role === 'user'
                    ? 'bg-blue-600 text-white rounded-br-none'
                    : 'bg-gray-700 text-gray-100 rounded-bl-none'
            }`;
            messageBubble.innerHTML = `<p class="text-sm md:text-base">${text}</p>`;

            messageContainer.appendChild(messageBubble);
            chatHistory.appendChild(messageContainer);
            setTimeout(scrollToBottom, 50); // Small delay to allow rendering before scroll
        };

        // Function to show/hide loading indicator
        const showLoadingIndicator = () => {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-gray-700 text-gray-100 rounded-xl rounded-bl-none p-3 max-w-xs md:max-w-md shadow-lg">
                    <div class="flex space-x-1">
                        <span class="animate-pulse-dot bg-gray-400 rounded-full w-2 h-2"></span>
                        <span class="animate-pulse-dot bg-gray-400 rounded-full w-2 h-2 animation-delay-200"></span>
                        <span class="animate-pulse-dot bg-gray-400 rounded-full w-2 h-2 animation-delay-400"></span>
                    </div>
                </div>
            `;
            chatHistory.appendChild(loadingDiv);
            scrollToBottom();
        };

        const hideLoadingIndicator = () => {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        };

        // Function to call the API with exponential backoff
        const callApiWithBackoff = async (url, options, retries = 5, delay = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    console.error(`API response not OK: Status ${response.status}, StatusText: ${response.statusText}`);
                    let errorBody = "No additional error details.";
                    try {
                        const errorJson = await response.json();
                        errorBody = JSON.stringify(errorJson);
                    } catch (jsonError) {
                        try {
                            errorBody = await response.text();
                        } catch (textError) {
                            console.error("Could not parse error response as JSON or text:", textError);
                        }
                    }
                    console.error("API Error Body:", errorBody);

                    if (response.status === 429 && retries > 0) {
                        console.warn(`Rate limit hit, retrying in ${delay / 1000}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        return callApiWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`API error: ${response.statusText || 'Unknown error'} - Details: ${errorBody}`);
                }
                return response.json();
            } catch (error) {
                console.error("Fetch error:", error);
                throw error;
            }
        };

        // Handle sending messages
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputMessage = userInput.value.trim();

            if (!inputMessage || sendButton.disabled) return;

            // Remove initial message if present
            if (initialMessageDiv) {
                initialMessageDiv.remove();
                // FIX: Removed reassignment to null, as it's not strictly necessary for this logic
                // and the variable is already declared with 'let'.
            }

            createMessageElement(inputMessage, 'user');
            messages.push({ role: 'user', content: inputMessage });
            userInput.value = '';
            sendButton.disabled = true; // Disable button while loading
            showLoadingIndicator();

            try {
                // Define the system message for EDITH's persona
                const systemMessage = {
                    role: 'system',
                    content: "You are EDITH, a smart glasses assistant. Your responses should be concise and helpful about 20 words, unless a detailed explanation is specifically requested. Use a professional yet friendly tone."
                };

                // Construct chat history for the API call in Groq's expected format
                // Include the system message at the beginning of the conversation
                const chatHistoryForApi = [systemMessage, ...messages].map(msg => ({
                    role: msg.role === 'user' ? 'user' : (msg.role === 'system' ? 'system' : 'assistant'),
                    content: msg.content
                }));

                const apiKey = "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"; // Your Groq API key
                const apiUrl = "https://api.groq.com/openai/v1/chat/completions";

                const payload = {
                    messages: chatHistoryForApi,
                    model: "llama3-8b-8192",
                };

                const result = await callApiWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                hideLoadingIndicator();

                if (result.choices && result.choices.length > 0 &&
                    result.choices[0].message && result.choices[0].message.content) {
                    const aiResponseText = result.choices[0].message.content;
                    createMessageElement(aiResponseText, 'model');
                    messages.push({ role: 'model', content: aiResponseText });
                } else {
                    createMessageElement("Sorry, I couldn't get a response. Please try again.", 'model');
                    console.error("Unexpected Groq API response structure:", result);
                }
            } catch (error) {
                hideLoadingIndicator();
                createMessageElement(`An error occurred: ${error.message}. Please try again.`, 'model');
                console.error("Error sending message:", error);
            } finally {
                sendButton.disabled = false; // Re-enable button
            }
        });

        // Enable/disable send button based on input
        userInput.addEventListener('input', () => {
            sendButton.disabled = userInput.value.trim() === '';
        });

        // Initial state of send button
        sendButton.disabled = true;
    </script>
</body>
</html>
